<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>BuddyFit 아키텍처 다이제스트</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Pretendard', -apple-system, 'Noto Sans KR', sans-serif; background: #f5f5f7; padding: 28px; color: #111; }
  .page { max-width: 1200px; margin: 0 auto; background: #fff; border-radius: 16px; padding: 40px; box-shadow: 0 10px 32px rgba(0,0,0,0.08); }
  h1 { font-size: 30px; font-weight: 800; margin-bottom: 6px; }
  .subtitle { font-size: 14px; color: #666; margin-bottom: 24px; }
  .section { margin-bottom: 32px; }
  .section-title { font-size: 20px; font-weight: 700; margin-bottom: 12px; border-bottom: 2px solid #e0e0e0; padding-bottom: 6px; }
  .pipeline { display: flex; flex-direction: column; gap: 0; }
  .stage { border-radius: 14px; padding: 18px 24px; position: relative; background: #fff; margin-bottom: 12px; border: 1px solid #ececec; }
  .stage-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
  .stage-num { font-size: 13px; font-weight: 800; color: #fff; background: #1d3557; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .stage-title { font-size: 18px; font-weight: 700; }
  .stage-req { font-size: 11px; color: #555; background: #f0f0f0; padding: 2px 8px; border-radius: 999px; margin-left: auto; }
  .stage-columns { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 14px; font-size: 14px; line-height: 1.6; }
  .col { background: rgba(255,255,255,0.8); border-radius: 10px; padding: 10px 14px; border: 1px solid #f0f0f0; }
  .col-label { font-size: 11px; font-weight: 700; color: #666; text-transform: uppercase; letter-spacing: 0.4px; margin-bottom: 6px; }
  .highlight { background: #fff3d4; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
  .badge { display: inline-flex; align-items: center; gap: 4px; background: #e4f0ff; color: #1565c0; padding: 2px 6px; border-radius: 5px; font-size: 11px; font-weight: 600; }
  .legend-strip { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 16px; }
  .legend-item { display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 10px; background: #f5f5f5; font-size: 12px; }
  .legend-dot { width: 10px; height: 10px; border-radius: 50%; }
  code { background: #f1f3f5; padding: 1px 4px; border-radius: 4px; font-size: 12px; }
  .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
  .detail-card { border-radius: 12px; padding: 16px; border: 1px solid #ececec; background: #fff; }
  .detail-card h3 { font-size: 16px; margin-bottom: 6px; }
  .detail-card ul { margin-top: 6px; list-style: none; padding-left: 14px; font-size: 13px; color: #333; }
  .detail-card ul li::before { content: "•"; margin-right: 6px; color: #1d3557; }
</style>
  <link rel="stylesheet" href="site.css" />
</head>
<body>

<nav class="nav">
  <a href="index.html">← Home</a>
</nav>

<div class="page">
  <h1>BuddyFit 워크플로우 & 인프라 다이제스트</h1>
  <p class="subtitle">LangGraph 8개 노드 흐름과 RAG/툴/메모리 설계를 falling/.html 수준의 시각으로 정리했습니다.</p>
  <div class="section">
    <div class="section-title">워크플로우 노드</div>
    <div class="pipeline">
      <div class="stage">
        <div class="stage-header">
          <div class="stage-num">1</div>
          <div class="stage-title">ContextCollector</div>
          <div class="stage-req">REQ: 상태 동기화</div>
        </div>
        <div class="stage-columns">
          <div class="col">
            <div class="col-label">입력</div>
            `today_context`, `local_time`, `user_id`, `pair_id` (GraphState)<br>
            디스크의 기존 `UserState`, `TeamState` 스냅샷
          </div>
          <div class="col">
            <div class="col-label">툴</div>
            `get_user_state`, `get_team_state` (`utils.retry.call_tool_with_retry` 경유)<br>
            `append_event_log`(`CONTEXT_SUBMITTED`)
          </div>
          <div class="col">
            <div class="col-label">출력</div>
            `user_profile`, `latest_mission`, `history_7d`, `risk_score`, `sync_window`, `manual_send_only` 갱신<br>
            이벤트 로그 + `refinement_count` 초기화
          </div>
        </div>
      </div>
      <div class="stage">
        <div class="stage-header">
          <div class="stage-num">2</div>
          <div class="stage-title">Planner</div>
          <div class="stage-req">REQ: RAG + 안전</div>
        </div>
        <div class="stage-columns">
          <div class="col">
            <div class="col-label">입력</div>
            `today_context`, `history_7d`, `user_profile`, `refinement_count`, `manual_send_only`<br>
            패턴 오버라이드로 계산한 `duration`, `strategy`, `max_intensity`
          </div>
          <div class="col">
            <div class="col-label">단계</div>
            0) 패턴 오버라이드(다운시프트): tired/miss_streak≥2 → 2분·저강도 전환<br>
            1) Long Memory 힌트 (`query_long_memory`)<br>
            2) 조건 기반 쿼리 생성<br>
            3) `search_rag_cards` (FAISS → 하드 필터 + 재정렬)<br>
            4) 추가 필터(`condition_fit`, `space`), Tier 정책<br>
            5) `safety_check_plan` (avoid + intensity) → 패치/폴백<br>
            6) Top-1 vs Alt-1 선택<br>
            7) `build_min_action_plan` + 선택적 LLM 정제<br>
            8) 실패 시 폴백 미션 + 이벤트
          </div>
          <div class="col">
            <div class="col-label">출력</div>
            `latest_mission` + `min_action_plan` JSON<br>
            검색 메타, 폴백 플래그, `answer_card_id`, `used_fallback`, `safety_action`
          </div>
        </div>
      </div>
      <div class="stage">
        <div class="stage-header">
          <div class="stage-num">3</div>
          <div class="stage-title">Reflector</div>
          <div class="stage-req">REQ: 플랜 검증</div>
        </div>
        <div class="stage-columns">
          <div class="col">
            <div class="col-label">로직</div>
            - `duration` > budget → 재설계<br>
            - `tired` + intensity ≥ 3 → 재설계<br>
            - `refinement_count` ≥ 2 → 무조건 PASS
          </div>
          <div class="col">
            <div class="col-label">라우팅</div>
            에지 결과 `replan` / `pass` 반환<br>
            `pass`는 Monitor, `replan`은 Planner 재진입
          </div>
          <div class="col">
            <div class="col-label">텔레메트리</div>
            콘솔 트레이스 + 루프 방지를 위한 사유 로깅
          </div>
        </div>
      </div>
      <div class="stage">
        <div class="stage-header">
          <div class="stage-num">4</div>
          <div class="stage-title">Monitor</div>
          <div class="stage-req">REQ: 리듬 이탈 감지</div>
        </div>
        <div class="stage-columns">
          <div class="col">
            <div class="col-label">트리거</div>
            T1: `local_time` hour ≥ 23 + 미션 미완료<br>
            T2: `history_7d.skipped_count` ≥ 2
          </div>
          <div class="col">
            <div class="col-label">행동</div>
            `append_event_log`(`RHYTHM_BREAK_DETECTED`) 기록<br>
            트리거 시 `intervention`, 아니면 `output`
          </div>
          <div class="col">
            <div class="col-label">출력</div>
            상태는 바꾸지 않으며 라우팅 레이블만 반환
          </div>
        </div>
      </div>
      <div class="stage">
        <div class="stage-header">
          <div class="stage-num">5</div>
          <div class="stage-title">Intervention</div>
          <div class="stage-req">REQ: 케어 + 다운시프트</div>
        </div>
        <div class="stage-columns">
          <div class="col">
            <div class="col-label">신호</div>
            `today_context`, `free_text`, `history_7d`, `user_profile` 활용<br>
            `query_long_memory`(`failure_reason`)으로 공감 단서 수집
          </div>
          <div class="col">
            <div class="col-label">플랜</div>
            2분 다운시프트 카드(`MA_HOME_2_MARCH_001`) + 안전 점검<br>
            severity 1이면 패치, 아니면 안내 메시지<br>
            `INTERVENTION_GENERATED` 이벤트 + 시스템 메시지
          </div>
          <div class="col">
            <div class="col-label">출력</div>
            갱신된 `latest_mission`, `last_intervention_at`, `system_message` (system_action은 유지)
          </div>
        </div>
      </div>
      <div class="stage">
        <div class="stage-header">
          <div class="stage-num">6</div>
          <div class="stage-title">Output</div>
          <div class="stage-req">REQ: 안전 가드레일</div>
        </div>
        <div class="stage-columns">
          <div class="col">
            <div class="col-label">입력</div>
            `latest_mission`, `system_message`, `user_id`, `pair_id`<br>
            `filter_output`로 톤/의학적 문구 필터링
          </div>
          <div class="col">
            <div class="col-label">행동</div>
            `safety_gate.filter_output` 호출 → 문구 대체<br>
            면책 문구 추가 + `GUARDRAIL_TRIGGERED` 로그
          </div>
          <div class="col">
            <div class="col-label">출력</div>
            필터링된 `system_message`, `OUTPUT_DELIVERED` 이벤트<br>
            가드레일 카운트 + 노출 메시지 준비
          </div>
        </div>
      </div>
      <div class="stage">
        <div class="stage-header">
          <div class="stage-num">7</div>
          <div class="stage-title">PostAction</div>
          <div class="stage-req">REQ: 피드백 루프</div>
        </div>
        <div class="stage-columns">
          <div class="col">
            <div class="col-label">행동</div>
            UI로 전달된 `system_action` ∈ {`completed`,`skipped`,`too_hard`,`feedback`}<br>
            `action_payload`에서 반영/이유/피드백 추출
          </div>
          <div class="col">
            <div class="col-label">업데이트</div>
            `update_user_state`(dot notation + `$increment`), `upsert_long_memory` (skip/feedback)<br>
            액션별 이벤트 (`MISSION_COMPLETED`, `USER_FEEDBACK` 등)
          </div>
          <div class="col">
            <div class="col-label">라우팅</div>
            `completed`→`buddy_sync`, `feedback`→`planner`, 기타→`__end__`
          </div>
        </div>
      </div>
      <div class="stage">
        <div class="stage-header">
          <div class="stage-num">8</div>
          <div class="stage-title">BuddySync</div>
          <div class="stage-req">REQ: 팀 터치</div>
        </div>
        <div class="stage-columns">
          <div class="col">
            <div class="col-label">입력</div>
            `pair_id`, `sync_window`, `buddy_ids`, `manual_send_only` (GraphState)<br>
            `get_team_state` + 이벤트 히스토리
          </div>
          <div class="col">
            <div class="col-label">로직</div>
            역할(A/B) 판별 → 완료 플래그 설정<br>
            `BUDDY_COMPLETED` + `TEAM_TOUCH_CONFIRMED`/`NUDGE_BUTTON_SENT` 로그<br>
            `update_team_state` 패치 + `$increment` 적용
          </div>
          <div class="col">
            <div class="col-label">출력</div>
            갱신된 `sync_window`, `weekly_team_touch_count`, `last_nudge_at`, `buddy_nudge` 패키지
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-title">RAG & 안전 설계</div>
    <div class="detail-grid">
      <div class="detail-card">
        <h3>search_rag_cards (`src/tools/rag.py`)</h3>
        <ul>
          <li>MiniLM-L12-v2 384d 임베딩 + FAISS(`data/faiss_index/rag_cards.index`)</li>
          <li>입력: 쿼리 텍스트 + 필터(place, duration, equipment, noise)</li>
          <li>top `min(ntotal, top_k×3)` 후보 검색 → 메타데이터 매핑</li>
          <li>하드 필터(장소, 시간, 장비 레벨, 강도, 소음) + 폴백 카드</li>
          <li>0.75×dense + 0.15×duration + 0.10×preference 가중 재정렬</li>
          <li>히트 목록, 응답 지연, 후보 수, fallback 플래그 포함 반환</li>
        </ul>
      </div>
      <div class="detail-card">
        <h3>safety_check_plan (`src/tools/rag.py`)</h3>
        <ul>
          <li>회피 동작 vs 강도 임계값 2단계</li>
          <li>severity 0→안전, severity 1→march/walk/wall_push 대체</li>
          <li>`today_context.condition`, `history_7d.miss_streak_days`, `user_profile.avoid_movements` 참조</li>
          <li>패치된 플랜은 `_safety_patched` 표시와 함께 Planner 후보로 합류</li>
          <li>안전 카드 없으면 2분 제자리 걷기 폴백 + 이유 메시지</li>
        </ul>
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-title">툴 경계</div>
    <div class="detail-grid">
      <div class="detail-card">
        <h3>State Tools (`src/tools/state.py`)</h3>
        <ul>
          <li>`get_user_state` / `get_team_state`: 쓰레드 락 + Pydantic 검증</li>
          <li>`update_user_state`: dot notation + `$increment` + `updated_at` 갱신</li>
          <li>`update_team_state`: 동일한 락 + sync window 파셜 업데이트</li>
          <li>모든 응답은 `ToolResponse`/`ToolError` 봉투</li>
          <li>`data/state/*.json`에 Short Memory 저장</li>
        </ul>
      </div>
      <div class="detail-card">
        <h3>Memory Tools (`src/tools/memory.py`)</h3>
        <ul>
          <li>FAISS(`data/faiss_index/long_memory.index`) + JSONL 메타 저장</li>
          <li>임베딩: `sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2` 재사용</li>
          <li>`query_long_memory`: 임베딩 → 검색 → 사용자/타입 필터 → 히트 반환</li>
          <li>`upsert_long_memory`: 텍스트 임베딩 → 벡터 + 메타 추가</li>
          <li>비ASCII 경로 대응 직렬화 + 7일 이상 정리 기능</li>
        </ul>
      </div>
      <div class="detail-card">
        <h3>관찰성 & 가드레일</h3>
        <ul>
          <li>`append_event_log`: `EventLog` 스키마 검증 + JSONL 추가</li>
          <li>`safety_gate.filter_output`: 의학 키워드 제거, 톤 완화, 면책 문구 삽입 + 로그</li>
          <li>`utils.retry.call_tool_with_retry`: 모든 툴 호출에 동일한 재시도/로깅</li>
          <li>전체 이벤트(CONTEXT_SUBMITTED, RETRIEVAL_FAILED, BUDDY_COMPLETED 등)는 단일 로그로 통합</li>
        </ul>
      </div>
    </div>
  </div>
  <div class="section">
    <div class="section-title">데이터 & 메모리 전략</div>
    <div class="detail-grid">
      <div class="detail-card">
        <h3>Short Memory (GraphState/UserState)</h3>
        <ul>
          <li>`UserState`: `today_context`, `latest_mission`, `history_7d`, `risk_score`, 회피/장비 목록</li>
          <li>`TeamState`: `sync_window`, `buddy_ids`, 넛지 플래그, 주간 터치 카운트</li>
          <li>`GraphState`: 위 내용을 합치고 `refinement_count`, `local_time`, `system_message`, `system_action` 포함</li>
          <li>`schemas/state.py`는 컨디션/장비/공간 등 엄격한 enum 계약</li>
          <li>`data/state/*.json`에서 스레드 락 + 원자 증가로 저장</li>
        </ul>
      </div>
      <div class="detail-card">
        <h3>Long Memory (FAISS)</h3>
        <ul>
          <li>`long_memory_manager.py`: 직렬화, 재빌드, 오래된 데이터 삭제 지원</li>
          <li>메모리 타입: `reflection`, `failure_reason`, `preference` (Planner/Intervention/PostAction 사용)</li>
          <li>인덱스/메타는 `data/faiss_index/`에, 384d 임베딩과 연동</li>
          <li>검색 흐름: Planner는 쿼리 힌트, Intervention은 실패회고, PostAction은 신규 저장</li>
        </ul>
      </div>
      <div class="detail-card">
        <h3>Event Log + 폴백 데이터</h3>
        <ul>
          <li>`data/event_log.jsonl`: 모든 이벤트를 `append_event_log`로 기록</li>
          <li>RETRIEVAL_FAILED, GUARDRAIL_TRIGGERED, BUDDY_COMPLETED 등 폴백 이유 포함</li>
          <li>폴백 미션 `MA_HOME_2_MARCH_001`로 사용자에게 빈 결과 없음</li>
          <li>RAG 카드 메타 + FAISS 인덱스(`data/faiss_index/rag_cards.*`)가 Planner 검색을 뒷받침</li>
        </ul>
      </div>
    </div>
  </div>
  <div class="legend-strip">
    <div class="legend-item"><span class="legend-dot" style="background:#1d3557"></span> LangGraph 노드 (Context → BuddySync)</div>
    <div class="legend-item"><span class="legend-dot" style="background:#2a9d8f"></span> FAISS 기반 검색 + Long Memory 힌트</div>
    <div class="legend-item"><span class="legend-dot" style="background:#e76f51"></span> 안전 가드레일 + 이벤트 로그</div>
    <div class="legend-item"><span class="legend-dot" style="background:#577590"></span> Dot-notation 상태 저장 + 수동 넛지</div>
  </div>
</div>
</body>
</html>